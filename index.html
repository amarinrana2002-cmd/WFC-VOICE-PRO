<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wavevoice Pro Video Editor - Ultra HD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- បញ្ចូល Fonts ខ្មែរពី Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Freehand&family=Kantumruy+Pro:wght@400;700&family=Moul&family=Siemreap&family=Chenla&display=swap" rel="stylesheet">
    <style>
        :root {
            --capcut-bg: #0a0a0a;
            --capcut-panel: #141414;
            --capcut-accent: #2c64f8;
            --capcut-border: rgba(255, 255, 255, 0.05);
        }

        body { 
            font-family: 'Inter', 'Kantumruy Pro', sans-serif; 
            background-color: var(--capcut-bg); 
            color: #e2e2e2; 
            overflow: hidden; 
            user-select: none;
        }

        .glass-panel { background: var(--capcut-panel); border: 1px solid var(--capcut-border); }
        
        .canvas-area {
            position: relative;
            max-width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 8px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }

        #mainCanvas { width: 100%; height: 100%; }

        .timeline-container {
            height: 280px;
            background: #0f0f0f;
            border-top: 1px solid var(--capcut-border);
        }

        .timeline-track {
            height: 44px;
            margin: 2px 0;
            background: rgba(255,255,255,0.02);
            display: flex;
            align-items: center;
            padding-left: 150px;
            position: relative;
            cursor: pointer;
            transition: 0.2s;
        }

        .timeline-track:hover { background: rgba(255,255,255,0.05); }

        .track-label {
            position: absolute; left: 0; width: 140px; height: 100%;
            background: #181818; display: flex; align-items: center;
            padding: 0 12px; font-size: 11px; border-right: 1px solid var(--capcut-border);
            z-index: 5; color: #aaa; overflow: hidden; white-space: nowrap;
        }

        .clip-block {
            background: var(--capcut-accent); height: 34px; border-radius: 4px; opacity: 0.7;
            box-shadow: 0 0 10px rgba(44, 100, 248, 0.3);
        }

        .playhead {
            position: absolute; top: 0; bottom: 0; width: 2px; background: #ff3e3e;
            left: 150px; z-index: 20; pointer-events: none;
        }

        .active-layer { background: rgba(44, 100, 248, 0.2) !important; border: 1px solid var(--capcut-accent) !important; }

        .cap-btn {
            display: flex; flex-direction: column; align-items: center; padding: 12px;
            border-radius: 10px; color: #777; transition: 0.3s;
        }
        .cap-btn:hover { color: #fff; background: #1a1a1a; }
        .cap-btn.active { color: var(--capcut-accent); }

        input[type="range"] { accent-color: var(--capcut-accent); }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="h-14 border-b border-white/5 flex items-center justify-between px-8 bg-[#000]">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-white">W</div>
            <h1 class="font-bold text-sm tracking-widest uppercase">Wavevoice <span class="text-blue-500">Ultra HD</span></h1>
        </div>
        <div class="flex gap-3">
            <select id="exportQuality" class="bg-[#1a1a1a] text-[11px] px-3 py-1 rounded border border-white/10 text-gray-400">
                <option value="1">720p (Normal)</option>
                <option value="2" selected>1080p (Full HD)</option>
                <option value="4">4K (Ultra HD)</option>
            </select>
            <button onclick="exportVideoHD()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-1.5 rounded-full text-[11px] font-black transition-all transform hover:scale-105">
                EXPORT HD
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar Tools -->
        <aside class="w-24 border-r border-white/5 flex flex-col py-6 gap-3 bg-[#000]">
            <button onclick="document.getElementById('videoInput').click()" class="cap-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="1.5"/></svg>
                <span class="text-[10px] mt-2">មេឌៀ</span>
            </button>
            <button onclick="addTextLayer()" class="cap-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16m-7 6h7" stroke-width="1.5"/></svg>
                <span class="text-[10px] mt-2">អត្ថបទ</span>
            </button>
            <button onclick="addWaveform()" class="cap-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 19V5l12 7-12 7z" stroke-width="1.5"/></svg>
                <span class="text-[10px] mt-2">រលកសម្លេង</span>
            </button>
            <input type="file" id="videoInput" accept="video/*" class="hidden">
        </aside>

        <!-- Main Workspace -->
        <div class="flex-1 flex flex-col bg-[#0d0d0d]">
            <div class="flex-1 flex items-center justify-center p-10 relative">
                <div class="canvas-area overflow-hidden" id="canvasContainer">
                    <canvas id="mainCanvas"></canvas>
                </div>

                <!-- Inspector Panel -->
                <div id="inspector" class="absolute right-8 top-8 w-72 glass-panel rounded-2xl p-6 hidden z-50 max-h-[80%] overflow-y-auto shadow-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-[12px] font-bold text-blue-500 uppercase tracking-widest text-center">ការកំណត់ LAYER</h3>
                        <button onclick="selectLayer(-1)" class="text-gray-500 hover:text-white">✕</button>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="space-y-3">
                            <label class="text-[10px] text-gray-500 uppercase font-bold">ឈ្មោះ Layer</label>
                            <input type="text" id="layerName" class="w-full bg-[#1a1a1a] text-xs p-3 rounded-lg border border-white/5 outline-none focus:border-blue-500">
                        </div>

                        <div id="textSettings" class="hidden space-y-5">
                            <div class="space-y-3">
                                <label class="text-[10px] text-gray-500 uppercase font-bold">អត្ថបទ</label>
                                <textarea id="layerText" class="w-full bg-[#1a1a1a] text-xs p-3 rounded-lg border border-white/5 h-20 outline-none focus:border-blue-500"></textarea>
                            </div>
                            <div class="space-y-3">
                                <label class="text-[10px] text-gray-500 uppercase font-bold">ពុម្ពអក្សរ</label>
                                <select id="layerFont" class="w-full bg-[#1a1a1a] text-xs p-3 rounded-lg border border-white/5 outline-none">
                                    <option value="'Kantumruy Pro'">Kantumruy Pro</option>
                                    <option value="'Siemreap'">Siemreap</option>
                                    <option value="'Moul'">Moul</option>
                                    <option value="'Chenla'">Chenla</option>
                                    <option value="'Freehand'">Freehand</option>
                                </select>
                            </div>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 text-[10px] text-gray-400">
                                    <input type="checkbox" id="textShadow"> ស្រមោល
                                </label>
                                <label class="flex items-center gap-2 text-[10px] text-gray-400">
                                    <input type="checkbox" id="textOutline"> គំនូសជុំវិញ
                                </label>
                            </div>
                        </div>

                        <div id="waveSettings" class="hidden space-y-5">
                            <div class="space-y-2">
                                <label class="text-[10px] text-gray-500 uppercase font-bold">ម៉ូដរលក</label>
                                <select id="waveStyle" class="w-full bg-[#1a1a1a] text-xs p-3 rounded-lg border border-white/5 outline-none">
                                    <option value="bars">Bars Classic</option>
                                    <option value="symmetric">Symmetric</option>
                                    <option value="circle">Center Circle</option>
                                    <option value="blocks">Digital Blocks</option>
                                    <option value="fire">Fire Peaks</option>
                                    <option value="heartbeat">Heartbeat</option>
                                </select>
                            </div>
                        </div>

                        <div class="space-y-4 pt-4 border-t border-white/5">
                            <div class="space-y-2">
                                <div class="flex justify-between text-[10px]"><span>ទំហំ (Scale)</span><span id="scaleVal">100%</span></div>
                                <input type="range" id="layerScale" min="0.1" max="5" step="0.1" class="w-full h-1 bg-gray-800 rounded-full">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] block text-gray-500 uppercase font-bold">ពណ៌ Layer</label>
                                <input type="color" id="layerColor" class="w-full h-10 bg-transparent border-none cursor-pointer">
                            </div>
                        </div>

                        <button onclick="deleteLayer()" class="w-full py-3 bg-red-950/20 text-red-500 text-[10px] rounded-xl font-bold hover:bg-red-900/40 transition">លុប LAYER</button>
                    </div>
                </div>
            </div>

            <!-- Timeline UI -->
            <div class="timeline-container flex flex-col shadow-inner">
                <div class="timeline-header h-12 border-b border-white/5 flex items-center px-6">
                    <div class="flex items-center gap-6">
                        <button id="playBtn" class="w-8 h-8 flex items-center justify-center hover:bg-white/5 rounded-full transition">
                            <svg id="playIcon" class="w-5 h-5 fill-white" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11v11.78a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.841z"/></svg>
                        </button>
                        <span id="timeDisplay" class="text-[11px] font-mono text-gray-500">00:00:00 / 00:00:00</span>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto relative" id="timelineArea">
                    <div id="timelineTracks"></div>
                    <div class="playhead" id="playhead"></div>
                </div>
            </div>
        </div>
    </div>

    <video id="sourceVideo" class="hidden" crossorigin="anonymous" playsinline></video>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        signInAnonymously(auth);

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('sourceVideo');
        const playBtn = document.getElementById('playBtn');
        const playhead = document.getElementById('playhead');

        let layers = [];
        let activeIndex = -1;
        let isDragging = false;
        let startX, startY;
        let audioCtx, analyzer, dataArray;

        class Layer {
            constructor(type) {
                this.id = Date.now();
                this.type = type;
                this.name = type === 'waveform' ? 'រលកសម្លេង' : 'អត្ថបទថ្មី';
                this.x = canvas.width / 2;
                this.y = canvas.height / 2;
                this.scale = 1;
                this.color = type === 'waveform' ? '#2c64f8' : '#ffffff';
                this.text = 'សរសេរអត្ថបទទីនេះ';
                this.font = "'Kantumruy Pro'";
                this.shadow = true;
                this.outline = false;
                this.waveStyle = 'bars';
            }
        }

        function init() {
            resize();
            requestAnimationFrame(draw);
        }

        function resize() {
            const container = document.getElementById('canvasContainer');
            if (container) {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
            }
        }
        window.onresize = resize;

        window.addTextLayer = () => {
            layers.push(new Layer('text'));
            selectLayer(layers.length - 1);
        };

        window.addWaveform = () => {
            const l = new Layer('waveform');
            l.y = canvas.height - 100;
            layers.push(l);
            selectLayer(layers.length - 1);
            if(video.src) initAudio();
        };

        function selectLayer(index) {
            activeIndex = index;
            const inspector = document.getElementById('inspector');
            const textSettings = document.getElementById('textSettings');
            const waveSettings = document.getElementById('waveSettings');
            
            if(index === -1) {
                inspector.classList.add('hidden');
            } else {
                const l = layers[index];
                inspector.classList.remove('hidden');
                document.getElementById('layerName').value = l.name;
                document.getElementById('layerScale').value = l.scale;
                document.getElementById('scaleVal').innerText = Math.round(l.scale * 100) + '%';
                document.getElementById('layerColor').value = l.color;

                textSettings.classList.toggle('hidden', l.type !== 'text');
                waveSettings.classList.toggle('hidden', l.type !== 'waveform');

                if(l.type === 'text') {
                    document.getElementById('layerText').value = l.text;
                    document.getElementById('layerFont').value = l.font;
                    document.getElementById('textShadow').checked = l.shadow;
                    document.getElementById('textOutline').checked = l.outline;
                } else if(l.type === 'waveform') {
                    document.getElementById('waveStyle').value = l.waveStyle;
                }
            }
            renderTimeline();
        }

        window.deleteLayer = () => {
            if(activeIndex !== -1) {
                layers.splice(activeIndex, 1);
                selectLayer(-1);
            }
        };

        function renderTimeline() {
            const container = document.getElementById('timelineTracks');
            container.innerHTML = '';
            layers.forEach((l, i) => {
                const track = document.createElement('div');
                track.className = `timeline-track ${i === activeIndex ? 'active-layer' : ''}`;
                track.onclick = () => selectLayer(i);
                track.innerHTML = `<div class="track-label">${l.name}</div><div class="clip-block" style="width: 80%; background: ${l.color}"></div>`;
                container.appendChild(track);
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if(video.readyState >= 2) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = '#050505';
                ctx.fillRect(0,0, canvas.width, canvas.height);
            }

            layers.forEach((l, i) => {
                ctx.save();
                if(l.type === 'text') {
                    ctx.font = `bold ${36 * l.scale}px ${l.font}`;
                    ctx.textAlign = 'center';
                    if(l.shadow) {
                        ctx.shadowColor = 'rgba(0,0,0,0.8)';
                        ctx.shadowBlur = 10;
                        ctx.shadowOffsetX = 4; ctx.shadowOffsetY = 4;
                    }
                    if(l.outline) {
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 6 * l.scale;
                        ctx.strokeText(l.text, l.x, l.y);
                    }
                    ctx.fillStyle = l.color;
                    ctx.fillText(l.text, l.x, l.y);
                } else if(l.type === 'waveform' && analyzer) {
                    analyzer.getByteFrequencyData(dataArray);
                    ctx.fillStyle = l.color;
                    const count = 50;
                    const barWidth = (canvas.width * 0.7 / count) * l.scale;

                    for(let j=0; j<count; j++) {
                        const h = (dataArray[j]/255) * 120 * l.scale;
                        const px = l.x + (j * barWidth);
                        const py = l.y;

                        if(l.waveStyle === 'bars') {
                            ctx.fillRect(px, py - h/2, barWidth - 4, h);
                        } else if(l.waveStyle === 'symmetric') {
                            ctx.fillRect(px, py - h, barWidth - 4, h * 2);
                        } else if(l.waveStyle === 'circle') {
                            const ang = (j/count) * Math.PI * 2;
                            const rx = l.x + Math.cos(ang) * (60 * l.scale + h);
                            const ry = l.y + Math.sin(ang) * (60 * l.scale + h);
                            ctx.fillRect(rx, ry, barWidth/2, barWidth/2);
                        } else if(l.waveStyle === 'blocks') {
                            const bs = 10 * l.scale;
                            for(let k=0; k<h/bs; k++) ctx.fillRect(px, py - (k * bs * 1.2), barWidth-2, bs);
                        } else if(l.waveStyle === 'fire') {
                            ctx.globalAlpha = 0.5;
                            ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px + barWidth/2, py-h*1.5); ctx.lineTo(px+barWidth, py); ctx.fill();
                            ctx.globalAlpha = 1;
                            ctx.beginPath(); ctx.moveTo(px+2, py); ctx.lineTo(px + barWidth/2, py-h); ctx.lineTo(px+barWidth-2, py); ctx.fill();
                        } else if(l.waveStyle === 'heartbeat') {
                            const modH = j%8 === 0 ? h*2 : h/3;
                            ctx.fillRect(px, py - modH, barWidth-2, modH*2);
                        }
                    }
                }

                if(i === activeIndex) {
                    ctx.strokeStyle = '#2c64f8';
                    ctx.setLineDash([5, 5]);
                    ctx.strokeRect(l.x - 100, l.y - 40, 200, 60);
                    ctx.setLineDash([]);
                }
                ctx.restore();
            });

            if(video.src && video.duration) {
                const progress = video.currentTime / video.duration;
                const timelineWidth = document.getElementById('timelineTracks').clientWidth - 150;
                playhead.style.left = (150 + (progress * timelineWidth)) + 'px';
                document.getElementById('timeDisplay').innerText = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
            }
            requestAnimationFrame(draw);
        }

        function formatTime(s) {
            const m = Math.floor(s/60).toString().padStart(2,'0');
            const sec = Math.floor(s%60).toString().padStart(2,'0');
            return `${m}:${sec}`;
        }

        document.getElementById('layerName').oninput = (e) => { if(activeIndex !== -1) { layers[activeIndex].name = e.target.value; renderTimeline(); } };
        document.getElementById('layerText').oninput = (e) => { if(activeIndex !== -1) layers[activeIndex].text = e.target.value; };
        document.getElementById('layerFont').onchange = (e) => { if(activeIndex !== -1) layers[activeIndex].font = e.target.value; };
        document.getElementById('textShadow').onchange = (e) => { if(activeIndex !== -1) layers[activeIndex].shadow = e.target.checked; };
        document.getElementById('textOutline').onchange = (e) => { if(activeIndex !== -1) layers[activeIndex].outline = e.target.checked; };
        document.getElementById('layerScale').oninput = (e) => {
            if(activeIndex !== -1) {
                layers[activeIndex].scale = parseFloat(e.target.value);
                document.getElementById('scaleVal').innerText = Math.round(e.target.value * 100) + '%';
            }
        };
        document.getElementById('layerColor').oninput = (e) => { if(activeIndex !== -1) layers[activeIndex].color = e.target.value; };
        document.getElementById('waveStyle').onchange = (e) => { if(activeIndex !== -1) layers[activeIndex].waveStyle = e.target.value; };

        canvas.onmousedown = (e) => {
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
            const my = (e.clientY - rect.top) * (canvas.height / rect.height);
            for(let i = layers.length-1; i >=0; i--) {
                const l = layers[i];
                if(mx > l.x - 100 && mx < l.x + 100 && my > l.y - 60 && my < l.y + 20) {
                    selectLayer(i); isDragging = true;
                    startX = mx - l.x; startY = my - l.y; return;
                }
            }
            selectLayer(-1);
        };
        window.onmousemove = (e) => {
            if(!isDragging || activeIndex === -1) return;
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
            const my = (e.clientY - rect.top) * (canvas.height / rect.height);
            layers[activeIndex].x = mx - startX;
            layers[activeIndex].y = my - startY;
        };
        window.onmouseup = () => isDragging = false;

        document.getElementById('videoInput').onchange = (e) => {
            const file = e.target.files[0];
            if(file) {
                video.src = URL.createObjectURL(file);
                video.load();
                video.onloadedmetadata = () => { initAudio(); renderTimeline(); };
            }
        };

        async function initAudio() {
            if(!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaElementSource(video);
                analyzer = audioCtx.createAnalyser();
                analyzer.fftSize = 256;
                source.connect(analyzer);
                analyzer.connect(audioCtx.destination);
                dataArray = new Uint8Array(analyzer.frequencyBinCount);
            }
        }

        playBtn.onclick = async () => {
            if(!video.src) return;
            if(audioCtx?.state === 'suspended') await audioCtx.resume();
            if(video.paused) {
                video.play();
                document.getElementById('playIcon').innerHTML = '<path d="M4 4h4v12H4V4zm8 0h4v12h-4V4z"/>';
            } else {
                video.pause();
                document.getElementById('playIcon').innerHTML = '<path d="M6.3 2.841A1.5 1.5 0 004 4.11v11.78a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.841z"/>';
            }
        };

        window.exportVideoHD = () => {
            if(!video.src) return;
            const qualityScale = parseInt(document.getElementById('exportQuality').value);
            const stream = canvas.captureStream(30);
            const recorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 10000000 * (qualityScale/2)
            });
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Wavevoice_Pro_${qualityScale === 4 ? '4K' : 'HD'}.webm`;
                a.click();
            };
            recorder.start();
            video.currentTime = 0; video.play();
            setTimeout(() => recorder.stop(), (video.duration || 5) * 1000);
        };

        init();
    </script>
</body>
</html>
