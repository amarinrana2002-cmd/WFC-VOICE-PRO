<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Recorder Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .record-pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        select option {
            background: #1e293b;
            color: #f8fafc;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md glass rounded-3xl p-8 shadow-2xl">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">
                Wavevoice
            </h1>
            <p class="text-slate-400 text-sm mt-2">Fluid audio capture</p>
        </div>

        <!-- Mic Selector -->
        <div class="mb-6">
            <label for="micSelect" class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 ml-1">Select Microphone</label>
            <div class="relative">
                <select id="micSelect" class="w-full bg-slate-900/50 border border-slate-700 text-slate-200 text-sm rounded-xl px-4 py-2.5 outline-none focus:border-blue-500 transition-colors appearance-none cursor-pointer">
                    <option value="">Requesting access...</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
            </div>
        </div>

        <!-- Visualizer -->
        <div class="relative h-40 w-full bg-slate-900/50 rounded-2xl mb-8 overflow-hidden border border-slate-700/50">
            <canvas id="visualizer" class="w-full h-full"></canvas>
            <div id="timer" class="absolute top-2 right-4 font-mono text-xl text-emerald-400 hidden">00:00</div>
        </div>

        <!-- Main Controls -->
        <div class="flex flex-col items-center gap-6">
            <div class="relative">
                <button id="recordBtn" class="w-20 h-20 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg shadow-red-500/20 active:scale-95">
                    <svg id="recordIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                    <svg id="stopIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white hidden" fill="currentColor" viewBox="0 0 24 24">
                        <rect x="6" y="6" width="12" height="12" rx="2" />
                    </svg>
                </button>
            </div>
            
            <p id="statusText" class="text-slate-400 font-medium">Tap to start recording</p>
        </div>

        <!-- Recordings List -->
        <div class="mt-10">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-slate-200">Recent Recordings</h2>
                <span id="recordingCount" class="text-xs bg-slate-700 px-2 py-1 rounded-full text-slate-300">0</span>
            </div>
            
            <div id="recordingsList" class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar pr-2">
                <div id="emptyState" class="text-center py-8 text-slate-500 italic text-sm">
                    No recordings yet.
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Component -->
    <div id="customAlert" class="fixed top-4 left-1/2 -translate-x-1/2 glass px-6 py-3 rounded-xl border-red-500/50 text-red-400 hidden transition-all duration-300 z-50">
        <span id="alertMsg"></span>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let audioContext;
        let analyzer;
        let dataArray;
        let animationId;
        let startTime;
        let timerInterval;
        let stream;
        let phase = 0;

        const recordBtn = document.getElementById('recordBtn');
        const recordIcon = document.getElementById('recordIcon');
        const stopIcon = document.getElementById('stopIcon');
        const statusText = document.getElementById('statusText');
        const timerDisplay = document.getElementById('timer');
        const recordingsList = document.getElementById('recordingsList');
        const emptyState = document.getElementById('emptyState');
        const recordingCount = document.getElementById('recordingCount');
        const micSelect = document.getElementById('micSelect');
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');

        async function initDevices() {
            try {
                const tempStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                tempStream.getTracks().forEach(track => track.stop());
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(device => device.kind === 'audioinput');
                
                micSelect.innerHTML = audioInputs.map(device => 
                    `<option value="${device.deviceId}">${device.label || 'Microphone ' + (micSelect.length + 1)}</option>`
                ).join('');

                if (audioInputs.length === 0) {
                    micSelect.innerHTML = '<option value="">No microphone found</option>';
                }
            } catch (err) {
                micSelect.innerHTML = '<option value="">Permission denied</option>';
            }
        }

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        initDevices();

        function showAlert(msg) {
            const alert = document.getElementById('customAlert');
            document.getElementById('alertMsg').innerText = msg;
            alert.classList.remove('hidden');
            setTimeout(() => alert.classList.add('hidden'), 3000);
        }

        async function startRecording() {
            try {
                const deviceId = micSelect.value;
                const constraints = {
                    audio: deviceId ? { deviceId: { exact: deviceId } } : true
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyzer = audioContext.createAnalyser();
                analyzer.fftSize = 256;
                source.connect(analyzer);
                
                const bufferLength = analyzer.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    addRecordingToList(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                    if (audioContext) audioContext.close();
                };

                mediaRecorder.start();
                
                recordBtn.classList.add('record-pulse');
                recordIcon.classList.add('hidden');
                stopIcon.classList.remove('hidden');
                statusText.innerText = 'Recording...';
                statusText.classList.add('text-red-400');
                timerDisplay.classList.remove('hidden');
                micSelect.disabled = true;
                
                startTimer();
                drawWave();

            } catch (err) {
                showAlert('Could not access selected microphone.');
                console.error(err);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                cancelAnimationFrame(animationId);
                clearInterval(timerInterval);
                
                recordBtn.classList.remove('record-pulse');
                recordIcon.classList.remove('hidden');
                stopIcon.classList.add('hidden');
                statusText.innerText = 'Tap to start recording';
                statusText.classList.remove('text-red-400');
                timerDisplay.classList.add('hidden');
                micSelect.disabled = false;
                
                canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const seconds = Math.floor((elapsed / 1000) % 60);
                const minutes = Math.floor((elapsed / 1000 / 60) % 60);
                timerDisplay.innerText = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 100);
        }

        // The "Wavevoice" Visualizer Logic
        function drawWave() {
            animationId = requestAnimationFrame(drawWave);
            analyzer.getByteFrequencyData(dataArray);

            // Calculate average frequency volume
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;
            const normalizedVol = average / 128; // scale volume for wave height

            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw background waves for depth
            drawSingleWave(normalizedVol, 0.5, '#3b82f6', 0.5, phase);
            drawSingleWave(normalizedVol, 0.3, '#10b981', 0.8, phase * 1.5);
            drawSingleWave(normalizedVol, 1.0, '#60a5fa', 1, phase * 0.8);

            phase += 0.05 + (normalizedVol * 0.1); // Speed up with volume
        }

        function drawSingleWave(volume, opacity, color, frequencyMult, phaseOffset) {
            canvasCtx.beginPath();
            canvasCtx.strokeStyle = color;
            canvasCtx.lineWidth = 2;
            canvasCtx.globalAlpha = opacity;

            const midY = canvas.height / 2;
            const amplitude = 5 + (volume * 50); // Base height + reactive height

            for (let x = 0; x <= canvas.width; x += 2) {
                // Sine wave formula: y = amplitude * sin(frequency * x + phase)
                const y = midY + Math.sin(x * 0.02 * frequencyMult + phaseOffset) * amplitude;
                if (x === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
            }

            canvasCtx.stroke();
            canvasCtx.globalAlpha = 1.0;
        }

        function addRecordingToList(blob) {
            emptyState.classList.add('hidden');
            const url = URL.createObjectURL(blob);
            const id = Date.now();
            const dateStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const recordingItem = document.createElement('div');
            recordingItem.className = 'bg-slate-800/50 p-3 rounded-xl border border-slate-700 flex flex-col gap-3 transition-all hover:border-slate-500';
            recordingItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-slate-300">Recording ${dateStr}</span>
                    <div class="flex gap-2">
                        <button onclick="downloadRecording('${url}', '${id}')" class="text-slate-400 hover:text-blue-400 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove(); updateCount();" class="text-slate-400 hover:text-red-400 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
                <audio controls src="${url}" class="w-full h-8 opacity-80"></audio>
            `;
            recordingsList.prepend(recordingItem);
            updateCount();
        }

        window.downloadRecording = (url, id) => {
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `voice-recording-${id}.wav`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        function updateCount() {
            const items = recordingsList.querySelectorAll('.bg-slate-800\\/50').length;
            recordingCount.innerText = items;
            if (items === 0) emptyState.classList.remove('hidden');
        }

        recordBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            } else {
                startRecording();
            }
        });

        navigator.mediaDevices.ondevicechange = initDevices;
    </script>
</body>
</html>
